{% extends "base.html" %}

{% block title %}Configuración - IA-Ops Portal{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1><i class="fas fa-cog"></i> Configuración del Sistema</h1>
                <p class="lead">Gestión de providers, integraciones y configuraciones del portal</p>
            </div>
            <div class="col-lg-4">
                <div class="d-grid gap-2">
                    <button class="btn btn-light btn-lg" onclick="saveAllConfigurations()">
                        <i class="fas fa-save"></i> Guardar Todo
                    </button>
                    <button class="btn btn-outline-light" onclick="testAllConnections()">
                        <i class="fas fa-plug"></i> Test Conexiones
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Configuration Tabs -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="providers-tab" data-bs-toggle="tab" data-bs-target="#providers" type="button">
                <i class="fas fa-plug"></i> Providers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="api-providers-tab" data-bs-toggle="tab" data-bs-target="#api-providers" type="button">
                <i class="fas fa-code"></i> API Providers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button">
                <i class="fas fa-shield-alt"></i> Autenticación
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button">
                <i class="fas fa-server"></i> Sistema
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button">
                <i class="fas fa-bell"></i> Notificaciones
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button">
                <i class="fas fa-tools"></i> Avanzado
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="configTabContent">
        <!-- Providers Section -->
        <div class="tab-pane fade show active" id="providers" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plug"></i> Configuración de Providers</h5>
                    <p class="mb-0 text-muted">Configura las integraciones con diferentes servicios y plataformas cloud</p>
                </div>
                <div class="card-body">
                    <!-- Provider Sub-tabs -->
                    <ul class="nav nav-pills mb-4" id="providerTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="github-subtab" data-bs-toggle="pill" data-bs-target="#github-content" type="button">
                                <i class="fab fa-github"></i> GitHub
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="azure-subtab" data-bs-toggle="pill" data-bs-target="#azure-content" type="button">
                                <i class="fab fa-microsoft"></i> Azure DevOps
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="aws-subtab" data-bs-toggle="pill" data-bs-target="#aws-content" type="button">
                                <i class="fab fa-aws"></i> AWS
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gcp-subtab" data-bs-toggle="pill" data-bs-target="#gcp-content" type="button">
                                <i class="fab fa-google"></i> GCP
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="oci-subtab" data-bs-toggle="pill" data-bs-target="#oci-content" type="button">
                                <i class="fas fa-cloud"></i> OCI
                            </button>
                        </li>
                    </ul>

                    <!-- Provider Sub-content -->
                    <div class="tab-content" id="providerTabContent">
                        <!-- GitHub Configuration -->
                        <div class="tab-pane fade show active" id="github-content" role="tabpanel">
                            <div id="githubStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de GitHub...
                            </div>
                            
                            <form id="githubForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="githubToken" class="form-label">Personal Access Token</label>
                                            <input type="password" class="form-control" id="githubToken" placeholder="ghp_...">
                                            <div class="form-text">
                                                <a href="https://github.com/settings/tokens" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Crear token en GitHub
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="githubUser" class="form-label">Usuario de GitHub</label>
                                            <input type="text" class="form-control" id="githubUser" placeholder="username">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveGitHubConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testGitHubConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Azure Configuration -->
                        <div class="tab-pane fade" id="azure-content" role="tabpanel">
                            <div id="azureStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de Azure...
                            </div>
                            
                            <form id="azureForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="azureOrganization" class="form-label">Organización</label>
                                            <input type="text" class="form-control" id="azureOrganization" placeholder="myorganization">
                                        </div>
                                        <div class="mb-3">
                                            <label for="azureProject" class="form-label">Proyecto (opcional)</label>
                                            <input type="text" class="form-control" id="azureProject" placeholder="myproject">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="azureToken" class="form-label">Personal Access Token</label>
                                            <input type="password" class="form-control" id="azureToken" placeholder="PAT token">
                                            <div class="form-text">
                                                <a href="https://dev.azure.com/_usersSettings/tokens" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Crear token en Azure DevOps
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveAzureConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testAzureConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- AWS Configuration -->
                        <div class="tab-pane fade" id="aws-content" role="tabpanel">
                            <div id="awsStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de AWS...
                            </div>
                            
                            <form id="awsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="awsAccessKey" class="form-label">Access Key ID</label>
                                            <input type="text" class="form-control" id="awsAccessKey" placeholder="AKIA...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="awsSecretKey" class="form-label">Secret Access Key</label>
                                            <input type="password" class="form-control" id="awsSecretKey" placeholder="Secret key">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="awsRegion" class="form-label">Región</label>
                                            <select class="form-select" id="awsRegion">
                                                <option value="us-east-1">US East (N. Virginia)</option>
                                                <option value="us-west-2">US West (Oregon)</option>
                                                <option value="eu-west-1">Europe (Ireland)</option>
                                                <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="awsProfile" class="form-label">Profile (opcional)</label>
                                            <input type="text" class="form-control" id="awsProfile" placeholder="default">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveAWSConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testAWSConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- GCP Configuration -->
                        <div class="tab-pane fade" id="gcp-content" role="tabpanel">
                            <div id="gcpStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de GCP...
                            </div>
                            
                            <form id="gcpForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="gcpProjectId" class="form-label">Project ID</label>
                                            <input type="text" class="form-control" id="gcpProjectId" placeholder="my-project-id">
                                        </div>
                                        <div class="mb-3">
                                            <label for="gcpRegion" class="form-label">Región</label>
                                            <select class="form-select" id="gcpRegion">
                                                <option value="us-central1">us-central1</option>
                                                <option value="us-east1">us-east1</option>
                                                <option value="europe-west1">europe-west1</option>
                                                <option value="asia-southeast1">asia-southeast1</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="gcpServiceAccount" class="form-label">Service Account Key (JSON)</label>
                                            <textarea class="form-control" id="gcpServiceAccount" rows="4" placeholder='{"type": "service_account", ...}'></textarea>
                                            <div class="form-text">
                                                <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Crear Service Account
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveGCPConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testGCPConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- OCI Configuration -->
                        <div class="tab-pane fade" id="oci-content" role="tabpanel">
                            <div id="ociStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de OCI...
                            </div>
                            
                            <form id="ociForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="ociTenancyId" class="form-label">Tenancy OCID</label>
                                            <input type="text" class="form-control" id="ociTenancyId" placeholder="ocid1.tenancy.oc1...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="ociUserId" class="form-label">User OCID</label>
                                            <input type="text" class="form-control" id="ociUserId" placeholder="ocid1.user.oc1...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="ociFingerprint" class="form-label">Key Fingerprint</label>
                                            <input type="text" class="form-control" id="ociFingerprint" placeholder="aa:bb:cc:dd...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="ociRegion" class="form-label">Región</label>
                                            <select class="form-select" id="ociRegion">
                                                <option value="us-ashburn-1">US East (Ashburn)</option>
                                                <option value="us-phoenix-1">US West (Phoenix)</option>
                                                <option value="eu-frankfurt-1">Europe (Frankfurt)</option>
                                                <option value="ap-tokyo-1">Asia Pacific (Tokyo)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="ociPrivateKey" class="form-label">Private Key</label>
                                            <textarea class="form-control" id="ociPrivateKey" rows="4" placeholder="-----BEGIN PRIVATE KEY-----"></textarea>
                                            <div class="form-text">
                                                <a href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Generar API Key
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveOCIConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testOCIConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Providers Section -->
        <div class="tab-pane fade" id="api-providers" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> Configuración de API Providers</h5>
                    <p class="mb-0 text-muted">Configura las APIs de inteligencia artificial y servicios externos</p>
                </div>
                <div class="card-body">
                    <!-- API Provider Sub-tabs -->
                    <ul class="nav nav-pills mb-4" id="apiProviderTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="openai-subtab" data-bs-toggle="pill" data-bs-target="#openai-content" type="button">
                                <i class="fas fa-brain"></i> OpenAI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="google-subtab" data-bs-toggle="pill" data-bs-target="#google-content" type="button">
                                <i class="fab fa-google"></i> Google AI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bedrock-subtab" data-bs-toggle="pill" data-bs-target="#bedrock-content" type="button">
                                <i class="fab fa-aws"></i> AWS Bedrock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="anthropic-subtab" data-bs-toggle="pill" data-bs-target="#anthropic-content" type="button">
                                <i class="fas fa-robot"></i> Anthropic
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="azure-ai-subtab" data-bs-toggle="pill" data-bs-target="#azure-ai-content" type="button">
                                <i class="fab fa-microsoft"></i> Azure AI
                            </button>
                        </li>
                    </ul>

                    <!-- API Provider Sub-content -->
                    <div class="tab-content" id="apiProviderTabContent">
                        <!-- OpenAI Configuration -->
                        <div class="tab-pane fade show active" id="openai-content" role="tabpanel">
                            <div id="openaiStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de OpenAI...
                            </div>
                            
                            <form id="openaiForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="openaiApiKey" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="openaiApiKey" placeholder="sk-...">
                                            <div class="form-text">
                                                <a href="https://platform.openai.com/api-keys" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Obtener API Key
                                                </a>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="openaiOrganization" class="form-label">Organization ID (opcional)</label>
                                            <input type="text" class="form-control" id="openaiOrganization" placeholder="org-...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="openaiModel" class="form-label">Modelo por Defecto</label>
                                            <select class="form-select" id="openaiModel">
                                                <option value="gpt-4">GPT-4</option>
                                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                <option value="gpt-4o">GPT-4o</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="openaiMaxTokens" class="form-label">Max Tokens</label>
                                            <input type="number" class="form-control" id="openaiMaxTokens" value="4000" min="1" max="128000">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveOpenAIConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testOpenAIConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Google AI Configuration -->
                        <div class="tab-pane fade" id="google-content" role="tabpanel">
                            <div id="googleAIStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de Google AI...
                            </div>
                            
                            <form id="googleAIForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="googleAIApiKey" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="googleAIApiKey" placeholder="AIza...">
                                            <div class="form-text">
                                                <a href="https://makersuite.google.com/app/apikey" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Obtener API Key
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="googleAIModel" class="form-label">Modelo por Defecto</label>
                                            <select class="form-select" id="googleAIModel">
                                                <option value="gemini-pro">Gemini Pro</option>
                                                <option value="gemini-pro-vision">Gemini Pro Vision</option>
                                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveGoogleAIConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testGoogleAIConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- AWS Bedrock Configuration -->
                        <div class="tab-pane fade" id="bedrock-content" role="tabpanel">
                            <div id="bedrockStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de AWS Bedrock...
                            </div>
                            
                            <form id="bedrockForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="bedrockAccessKey" class="form-label">AWS Access Key</label>
                                            <input type="text" class="form-control" id="bedrockAccessKey" placeholder="AKIA...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="bedrockSecretKey" class="form-label">AWS Secret Key</label>
                                            <input type="password" class="form-control" id="bedrockSecretKey" placeholder="Secret key">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="bedrockRegion" class="form-label">Región</label>
                                            <select class="form-select" id="bedrockRegion">
                                                <option value="us-east-1">us-east-1</option>
                                                <option value="us-west-2">us-west-2</option>
                                                <option value="eu-west-1">eu-west-1</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="bedrockModel" class="form-label">Modelo por Defecto</label>
                                            <select class="form-select" id="bedrockModel">
                                                <option value="anthropic.claude-3-sonnet-20240229-v1:0">Claude 3 Sonnet</option>
                                                <option value="anthropic.claude-3-haiku-20240307-v1:0">Claude 3 Haiku</option>
                                                <option value="amazon.titan-text-express-v1">Titan Text Express</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveBedrockConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testBedrockConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Anthropic Configuration -->
                        <div class="tab-pane fade" id="anthropic-content" role="tabpanel">
                            <div id="anthropicStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de Anthropic...
                            </div>
                            
                            <form id="anthropicForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="anthropicApiKey" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="anthropicApiKey" placeholder="sk-ant-...">
                                            <div class="form-text">
                                                <a href="https://console.anthropic.com/" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Obtener API Key
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="anthropicModel" class="form-label">Modelo por Defecto</label>
                                            <select class="form-select" id="anthropicModel">
                                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveAnthropicConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testAnthropicConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Azure AI Configuration -->
                        <div class="tab-pane fade" id="azure-ai-content" role="tabpanel">
                            <div id="azureAIStatus" class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando estado de Azure AI...
                            </div>
                            
                            <form id="azureAIForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="azureAIApiKey" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="azureAIApiKey" placeholder="API key">
                                        </div>
                                        <div class="mb-3">
                                            <label for="azureAIEndpoint" class="form-label">Endpoint</label>
                                            <input type="url" class="form-control" id="azureAIEndpoint" placeholder="https://your-resource.openai.azure.com/">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="azureAIDeployment" class="form-label">Deployment Name</label>
                                            <input type="text" class="form-control" id="azureAIDeployment" placeholder="gpt-4">
                                        </div>
                                        <div class="mb-3">
                                            <label for="azureAIVersion" class="form-label">API Version</label>
                                            <select class="form-select" id="azureAIVersion">
                                                <option value="2024-02-15-preview">2024-02-15-preview</option>
                                                <option value="2023-12-01-preview">2023-12-01-preview</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveAzureAIConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="testAzureAIConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="tab-pane fade" id="auth" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shield-alt"></i> Gestión de Autenticación</h5>
                    <p class="mb-0 text-muted">Configuración de tokens y seguridad del sistema</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-key"></i> Token Actual</h6>
                                </div>
                                <div class="card-body">
                                    <div id="currentTokenStatus" class="mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <span>Verificando token...</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Token</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="currentToken" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility()">
                                                <i class="fas fa-eye" id="tokenEye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Expira</label>
                                        <input type="text" class="form-control" id="tokenExpiry" readonly>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="refreshToken()">
                                            <i class="fas fa-sync"></i> Renovar Token
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="revokeToken()">
                                            <i class="fas fa-times"></i> Revocar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-cogs"></i> Configuración Manual</h6>
                                </div>
                                <div class="card-body">
                                    <form id="manualAuthForm">
                                        <div class="mb-3">
                                            <label for="manualApiKey" class="form-label">API Key Manual</label>
                                            <input type="password" class="form-control" id="manualApiKey" placeholder="iaops-api-key-2024">
                                            <div class="form-text">Solo para configuración manual avanzada</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="backendUrl" class="form-label">Backend URL</label>
                                            <input type="url" class="form-control" id="backendUrl" value="http://localhost:8846">
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                                <label class="form-check-label" for="autoRefresh">
                                                    Auto-renovar token
                                                </label>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-success" onclick="manualAuthenticate()">
                                                <i class="fas fa-sign-in-alt"></i> Autenticar
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="testAuthentication()">
                                                <i class="fas fa-check"></i> Probar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Configuration -->
        <div class="tab-pane fade" id="system" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-database"></i> Base de Datos PostgreSQL</h6>
                        </div>
                        <div class="card-body">
                            <div id="dbStatus" class="mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>Verificando conexión...</span>
                                </div>
                            </div>
                            <form id="postgresForm">
                                <div class="mb-3">
                                    <label for="postgresHost" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="postgresHost" value="localhost">
                                </div>
                                <div class="mb-3">
                                    <label for="postgresPort" class="form-label">Puerto</label>
                                    <input type="number" class="form-control" id="postgresPort" value="5434">
                                </div>
                                <div class="mb-3">
                                    <label for="postgresDatabase" class="form-label">Base de Datos</label>
                                    <input type="text" class="form-control" id="postgresDatabase" value="postgres">
                                </div>
                                <div class="mb-3">
                                    <label for="postgresUser" class="form-label">Usuario</label>
                                    <input type="text" class="form-control" id="postgresUser" value="postgres">
                                </div>
                                <div class="mb-3">
                                    <label for="postgresPassword" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="postgresPassword" placeholder="••••••••">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="savePostgresConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testDatabaseConnection()">
                                        <i class="fas fa-plug"></i> Test Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-memory"></i> Redis Cache</h6>
                        </div>
                        <div class="card-body">
                            <div id="redisStatus" class="mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>Verificando conexión...</span>
                                </div>
                            </div>
                            <form id="redisForm">
                                <div class="mb-3">
                                    <label for="redisHost" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="redisHost" value="localhost">
                                </div>
                                <div class="mb-3">
                                    <label for="redisPort" class="form-label">Puerto</label>
                                    <input type="number" class="form-control" id="redisPort" value="6380">
                                </div>
                                <div class="mb-3">
                                    <label for="redisPassword" class="form-label">Contraseña (opcional)</label>
                                    <input type="password" class="form-control" id="redisPassword" placeholder="••••••••">
                                </div>
                                <div class="mb-3">
                                    <label for="redisDatabase" class="form-label">Base de Datos</label>
                                    <input type="number" class="form-control" id="redisDatabase" value="0" min="0" max="15">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveRedisConfig()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testRedisConnection()">
                                        <i class="fas fa-plug"></i> Test Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-hdd"></i> MinIO Storage</h6>
                </div>
                <div class="card-body">
                    <div id="minioStatus" class="mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Verificando conexión...</span>
                        </div>
                    </div>
                    <form id="minioForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="minioHost" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="minioHost" value="localhost">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="minioPort" class="form-label">Puerto</label>
                                    <input type="number" class="form-control" id="minioPort" value="9899">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="minioAccessKey" class="form-label">Access Key</label>
                                    <input type="text" class="form-control" id="minioAccessKey" value="minioadmin">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="minioSecretKey" class="form-label">Secret Key</label>
                                    <input type="password" class="form-control" id="minioSecretKey" placeholder="••••••••">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="minioBucket" class="form-label">Bucket Principal</label>
                                    <input type="text" class="form-control" id="minioBucket" value="iaops-portal">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="minioRegion" class="form-label">Región</label>
                                    <input type="text" class="form-control" id="minioRegion" value="us-east-1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">SSL</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="minioSSL">
                                        <label class="form-check-label" for="minioSSL">
                                            Usar HTTPS
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary btn-sm" onclick="saveMinIOConfig()">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="testMinIOConnection()">
                                <i class="fas fa-plug"></i> Test Conexión
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="createMinioBucket()">
                                <i class="fas fa-plus"></i> Crear Bucket
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notifications Configuration -->
        <div class="tab-pane fade" id="notifications" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bell"></i> Configuración de Notificaciones</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Notificaciones del Sistema</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyBuilds" checked>
                                <label class="form-check-label" for="notifyBuilds">Builds completados</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyErrors" checked>
                                <label class="form-check-label" for="notifyErrors">Errores del sistema</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Configuración de Duración</h6>
                            <div class="mb-3">
                                <label for="notificationDuration" class="form-label">Duración (segundos)</label>
                                <input type="number" class="form-control" id="notificationDuration" value="5" min="1" max="30">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveNotificationSettings()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>

        <!-- Advanced Configuration -->
        <div class="tab-pane fade" id="advanced" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Configuración Avanzada</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Configuración de API</h6>
                            <div class="mb-3">
                                <label for="apiTimeout" class="form-label">Timeout de API (segundos)</label>
                                <input type="number" class="form-control" id="apiTimeout" value="30" min="5" max="300">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Configuración de Tareas</h6>
                            <div class="mb-3">
                                <label for="taskTimeout" class="form-label">Timeout de Tareas (minutos)</label>
                                <input type="number" class="form-control" id="taskTimeout" value="30" min="1" max="180">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveAdvancedSettings()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeAuth();
        loadAllConfigurations();
        checkSystemStatus();
    });

    // ============================================================================
    // AUTHENTICATION
    // ============================================================================

    async function initializeAuth() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            await authenticateWithBackend();
        } else {
            // Verificar si el token es válido
            try {
                await apiCall('/api/auth/verify');
            } catch (error) {
                await authenticateWithBackend();
            }
        }
    }

    async function authenticateWithBackend() {
        try {
            const response = await fetch('http://localhost:8846/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_key: 'iaops-api-key-2024'
                })
            });

            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('authToken', data.access_token);
                localStorage.setItem('tokenExpiry', Date.now() + (data.expires_in * 1000));
                console.log('Authentication successful');
            } else {
                showError('Error de autenticación con el backend');
            }
        } catch (error) {
            console.error('Authentication failed:', error);
            showError('No se pudo conectar con el backend');
        }
    }

    function getAuthHeaders() {
        const token = localStorage.getItem('authToken');
        if (token) {
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        return {
            'Content-Type': 'application/json'
        };
    }

    async function apiCall(endpoint, method = 'GET', data = null) {
        const token = localStorage.getItem('authToken');
        const tokenExpiry = localStorage.getItem('tokenExpiry');
        
        // Verificar si el token ha expirado
        if (tokenExpiry && Date.now() > parseInt(tokenExpiry)) {
            await authenticateWithBackend();
        }
        
        const config = {
            method: method,
            headers: getAuthHeaders()
        };
        
        if (data && method !== 'GET') {
            config.body = JSON.stringify(data);
        }
        
        try {
            const response = await fetch(`http://localhost:8846${endpoint}`, config);
            
            if (response.status === 401) {
                // Token inválido, re-autenticar
                await authenticateWithBackend();
                // Reintentar la llamada
                config.headers = getAuthHeaders();
                const retryResponse = await fetch(`http://localhost:8846${endpoint}`, config);
                return await retryResponse.json();
            }
            
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }

    async function loadAllConfigurations() {
        await Promise.all([
            loadGitHubConfig(),
            loadAzureConfig(),
            loadAWSConfig(),
            loadGCPConfig(),
            loadOCIConfig(),
            loadAPIProviderConfigurations(),
            loadAuthConfiguration(),
            loadSystemConfigurations(),
            loadNotificationSettings(),
            loadAdvancedSettings()
        ]);
    }

    async function loadGitHubConfig() {
        try {
            const data = await apiCall('/api/providers/github');
            if (data.success && data.config) {
                document.getElementById('githubUser').value = data.config.user || '';
                updateGitHubStatus(data.config.configured);
            }
        } catch (error) {
            console.error('Error loading GitHub config:', error);
        }
    }

    function updateGitHubStatus(configured) {
        const statusDiv = document.getElementById('githubStatus');
        if (configured) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> GitHub configurado correctamente';
        } else {
            statusDiv.className = 'alert alert-warning';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> GitHub no configurado';
        }
    }

    async function saveGitHubConfig() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        
        if (!token || !user) {
            showError('Todos los campos son requeridos');
            return;
        }
        
        try {
            const data = await apiCall('/api/providers/github', 'POST', {
                github_token: token,
                github_user: user
            });
            
            if (data.success) {
                showSuccess('GitHub configurado correctamente');
                updateGitHubStatus(true);
            } else {
                showError(`Error: ${data.error}`);
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function testGitHubConnection() {
        try {
            const data = await apiCall('/api/github/test', 'POST');
            if (data.success) {
                showSuccess(`Conexión exitosa con GitHub (${data.user.login})`);
            } else {
                showError(`Error en conexión: ${data.error}`);
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function checkSystemStatus() {
        try {
            const data = await apiCall('/api/system/status');
            if (data.status === 'success') {
                updateSystemStatus(data.services.external_services);
            }
        } catch (error) {
            console.error('Error checking system status:', error);
        }
    }

    function updateSystemStatus(services) {
        const dbStatus = document.getElementById('dbStatus');
        const dbHealthy = services.postgres === 'healthy';
        dbStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${dbHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${dbHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;

        const redisStatus = document.getElementById('redisStatus');
        const redisHealthy = services.redis === 'healthy';
        redisStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${redisHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${redisHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;

        const minioStatus = document.getElementById('minioStatus');
        const minioHealthy = services.minio === 'healthy';
        minioStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${minioHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${minioHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;
    }

    // Placeholder functions for other providers
    async function loadAzureConfig() { updateAzureStatus(false); }
    async function loadAWSConfig() { updateAWSStatus(false); }
    async function loadGCPConfig() { updateGCPStatus(false); }
    async function loadOCIConfig() { updateOCIStatus(false); }

    function updateAzureStatus(configured) {
        const statusDiv = document.getElementById('azureStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> Azure DevOps configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> Azure DevOps no configurado';
    }

    function updateAWSStatus(configured) {
        const statusDiv = document.getElementById('awsStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> AWS configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> AWS no configurado';
    }

    function updateGCPStatus(configured) {
        const statusDiv = document.getElementById('gcpStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> GCP configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> GCP no configurado';
    }

    function updateOCIStatus(configured) {
        const statusDiv = document.getElementById('ociStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> OCI configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> OCI no configurado';
    }

    function saveAzureConfig() { showSuccess('Azure configurado (simulado)'); }
    function testAzureConnection() { showSuccess('Conexión Azure OK (simulado)'); }
    function saveAWSConfig() { showSuccess('AWS configurado (simulado)'); }
    function testAWSConnection() { showSuccess('Conexión AWS OK (simulado)'); }
    function saveGCPConfig() { showSuccess('GCP configurado (simulado)'); }
    function testGCPConnection() { showSuccess('Conexión GCP OK (simulado)'); }
    function saveOCIConfig() { showSuccess('OCI configurado (simulado)'); }
    function testOCIConnection() { showSuccess('Conexión OCI OK (simulado)'); }

    function loadNotificationSettings() {}
    function saveNotificationSettings() { showSuccess('Notificaciones guardadas'); }
    function loadAdvancedSettings() {}
    function saveAdvancedSettings() { showSuccess('Configuración avanzada guardada'); }

    async function testDatabaseConnection() {
        try {
            showInfo('Probando conexión a PostgreSQL...');
            const data = await apiCall('/api/test/database', 'POST');
            
            if (data.success) {
                showSuccess(`PostgreSQL: ${data.message}`);
                updateDatabaseStatus(data.status);
            } else {
                showError(`PostgreSQL: ${data.message}`);
                updateDatabaseStatus(data.status);
            }
        } catch (error) {
            showError('Error conectando con PostgreSQL');
            updateDatabaseStatus('unavailable');
        }
    }

    async function testRedisConnection() {
        try {
            showInfo('Probando conexión a Redis...');
            const data = await apiCall('/api/test/redis', 'POST');
            
            if (data.success) {
                showSuccess(`Redis: ${data.message}`);
                updateRedisStatus(data.status);
            } else {
                showError(`Redis: ${data.message}`);
                updateRedisStatus(data.status);
            }
        } catch (error) {
            showError('Error conectando con Redis');
            updateRedisStatus('unavailable');
        }
    }

    async function testMinIOConnection() {
        try {
            showInfo('Probando conexión a MinIO...');
            const data = await apiCall('/api/test/minio', 'POST');
            
            if (data.success) {
                showSuccess(`MinIO: ${data.message}`);
                updateMinIOStatus(data.status);
            } else {
                showError(`MinIO: ${data.message}`);
                updateMinIOStatus(data.status);
            }
        } catch (error) {
            showError('Error conectando con MinIO');
            updateMinIOStatus('unavailable');
        }
    }

    function updateDatabaseStatus(status) {
        const dbStatus = document.getElementById('dbStatus');
        const isHealthy = status === 'healthy';
        dbStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${isHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;
    }

    function updateRedisStatus(status) {
        const redisStatus = document.getElementById('redisStatus');
        const isHealthy = status === 'healthy';
        redisStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${isHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;
    }

    function updateMinIOStatus(status) {
        const minioStatus = document.getElementById('minioStatus');
        const isHealthy = status === 'healthy';
        minioStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${isHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;
    }

    function updateMinIOStatus(status) {
        const minioStatus = document.getElementById('minioStatus');
        const isHealthy = status === 'healthy';
        minioStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isHealthy ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${isHealthy ? 'Conectado' : 'Desconectado'}</span>
            </div>
        `;
    }

    async function saveAllConfigurations() {
        try {
            saveSystemConfigurations();
            saveNotificationSettings();
            saveAdvancedSettings();
            showSuccess('Todas las configuraciones guardadas');
        } catch (error) {
            showError('Error guardando configuraciones');
        }
    }

    // ============================================================================
    // SYSTEM CONFIGURATIONS
    // ============================================================================

    function loadSystemConfigurations() {
        // Load PostgreSQL config
        const postgresConfig = JSON.parse(localStorage.getItem('postgresConfig') || '{}');
        document.getElementById('postgresHost').value = postgresConfig.host || 'localhost';
        document.getElementById('postgresPort').value = postgresConfig.port || 5434;
        document.getElementById('postgresDatabase').value = postgresConfig.database || 'postgres';
        document.getElementById('postgresUser').value = postgresConfig.user || 'postgres';
        
        // Load Redis config
        const redisConfig = JSON.parse(localStorage.getItem('redisConfig') || '{}');
        document.getElementById('redisHost').value = redisConfig.host || 'localhost';
        document.getElementById('redisPort').value = redisConfig.port || 6380;
        document.getElementById('redisDatabase').value = redisConfig.database || 0;
        
        // Load MinIO config
        const minioConfig = JSON.parse(localStorage.getItem('minioConfig') || '{}');
        document.getElementById('minioHost').value = minioConfig.host || 'localhost';
        document.getElementById('minioPort').value = minioConfig.port || 9899;
        document.getElementById('minioAccessKey').value = minioConfig.accessKey || 'minioadmin';
        document.getElementById('minioBucket').value = minioConfig.bucket || 'iaops-portal';
        document.getElementById('minioRegion').value = minioConfig.region || 'us-east-1';
        document.getElementById('minioSSL').checked = minioConfig.ssl || false;
    }

    function saveSystemConfigurations() {
        savePostgresConfig();
        saveRedisConfig();
        saveMinIOConfig();
    }

    function savePostgresConfig() {
        const config = {
            host: document.getElementById('postgresHost').value,
            port: parseInt(document.getElementById('postgresPort').value),
            database: document.getElementById('postgresDatabase').value,
            user: document.getElementById('postgresUser').value,
            password: document.getElementById('postgresPassword').value
        };
        
        if (!config.host || !config.port || !config.database || !config.user) {
            showError('Todos los campos de PostgreSQL son requeridos');
            return;
        }
        
        localStorage.setItem('postgresConfig', JSON.stringify(config));
        showSuccess('Configuración de PostgreSQL guardada');
    }

    function saveRedisConfig() {
        const config = {
            host: document.getElementById('redisHost').value,
            port: parseInt(document.getElementById('redisPort').value),
            password: document.getElementById('redisPassword').value,
            database: parseInt(document.getElementById('redisDatabase').value)
        };
        
        if (!config.host || !config.port) {
            showError('Host y puerto de Redis son requeridos');
            return;
        }
        
        localStorage.setItem('redisConfig', JSON.stringify(config));
        showSuccess('Configuración de Redis guardada');
    }

    function saveMinIOConfig() {
        const config = {
            host: document.getElementById('minioHost').value,
            port: parseInt(document.getElementById('minioPort').value),
            accessKey: document.getElementById('minioAccessKey').value,
            secretKey: document.getElementById('minioSecretKey').value,
            bucket: document.getElementById('minioBucket').value,
            region: document.getElementById('minioRegion').value,
            ssl: document.getElementById('minioSSL').checked
        };
        
        if (!config.host || !config.port || !config.accessKey || !config.bucket) {
            showError('Host, puerto, access key y bucket de MinIO son requeridos');
            return;
        }
        
        localStorage.setItem('minioConfig', JSON.stringify(config));
        showSuccess('Configuración de MinIO guardada');
    }

    async function createMinioBucket() {
        const config = JSON.parse(localStorage.getItem('minioConfig') || '{}');
        const bucketName = config.bucket || document.getElementById('minioBucket').value;
        
        if (!bucketName) {
            showError('Especifica un nombre de bucket');
            return;
        }
        
        try {
            showInfo(`Creando bucket ${bucketName}...`);
            // Simular creación de bucket
            setTimeout(() => {
                showSuccess(`Bucket ${bucketName} creado exitosamente`);
            }, 1000);
        } catch (error) {
            showError('Error creando bucket');
        }
    }

    // ============================================================================
    // API PROVIDERS CONFIGURATIONS
    // ============================================================================

    function loadAPIProviderConfigurations() {
        // Load OpenAI config
        const openaiConfig = JSON.parse(localStorage.getItem('openaiConfig') || '{}');
        document.getElementById('openaiOrganization').value = openaiConfig.organization || '';
        document.getElementById('openaiModel').value = openaiConfig.model || 'gpt-4';
        document.getElementById('openaiMaxTokens').value = openaiConfig.maxTokens || 4000;
        updateOpenAIStatus(openaiConfig.apiKey ? true : false);

        // Load Google AI config
        const googleAIConfig = JSON.parse(localStorage.getItem('googleAIConfig') || '{}');
        document.getElementById('googleAIModel').value = googleAIConfig.model || 'gemini-pro';
        updateGoogleAIStatus(googleAIConfig.apiKey ? true : false);

        // Load Bedrock config
        const bedrockConfig = JSON.parse(localStorage.getItem('bedrockConfig') || '{}');
        document.getElementById('bedrockAccessKey').value = bedrockConfig.accessKey || '';
        document.getElementById('bedrockRegion').value = bedrockConfig.region || 'us-east-1';
        document.getElementById('bedrockModel').value = bedrockConfig.model || 'anthropic.claude-3-sonnet-20240229-v1:0';
        updateBedrockStatus(bedrockConfig.accessKey && bedrockConfig.secretKey ? true : false);

        // Load Anthropic config
        const anthropicConfig = JSON.parse(localStorage.getItem('anthropicConfig') || '{}');
        document.getElementById('anthropicModel').value = anthropicConfig.model || 'claude-3-sonnet-20240229';
        updateAnthropicStatus(anthropicConfig.apiKey ? true : false);

        // Load Azure AI config
        const azureAIConfig = JSON.parse(localStorage.getItem('azureAIConfig') || '{}');
        document.getElementById('azureAIEndpoint').value = azureAIConfig.endpoint || '';
        document.getElementById('azureAIDeployment').value = azureAIConfig.deployment || '';
        document.getElementById('azureAIVersion').value = azureAIConfig.version || '2024-02-15-preview';
        updateAzureAIStatus(azureAIConfig.apiKey && azureAIConfig.endpoint ? true : false);
    }

    // OpenAI Functions
    function saveOpenAIConfig() {
        const config = {
            apiKey: document.getElementById('openaiApiKey').value,
            organization: document.getElementById('openaiOrganization').value,
            model: document.getElementById('openaiModel').value,
            maxTokens: parseInt(document.getElementById('openaiMaxTokens').value)
        };
        
        if (!config.apiKey) {
            showError('API Key de OpenAI es requerida');
            return;
        }
        
        localStorage.setItem('openaiConfig', JSON.stringify(config));
        updateOpenAIStatus(true);
        showSuccess('Configuración de OpenAI guardada');
    }

    function updateOpenAIStatus(configured) {
        const statusDiv = document.getElementById('openaiStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> OpenAI configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> OpenAI no configurado';
    }

    async function testOpenAIConnection() {
        showInfo('Probando conexión con OpenAI...');
        setTimeout(() => showSuccess('Conexión OpenAI OK (simulado)'), 1000);
    }

    // Google AI, Bedrock, Anthropic, Azure AI functions...
    function saveGoogleAIConfig() {
        const config = {
            apiKey: document.getElementById('googleAIApiKey').value,
            model: document.getElementById('googleAIModel').value
        };
        
        if (!config.apiKey) {
            showError('API Key de Google AI es requerida');
            return;
        }
        
        localStorage.setItem('googleAIConfig', JSON.stringify(config));
        updateGoogleAIStatus(true);
        showSuccess('Configuración de Google AI guardada');
    }

    function updateGoogleAIStatus(configured) {
        const statusDiv = document.getElementById('googleAIStatus');
        statusDiv.className = configured ? 'alert alert-success' : 'alert alert-warning';
        statusDiv.innerHTML = configured ? 
            '<i class="fas fa-check-circle"></i> Google AI configurado correctamente' :
            '<i class="fas fa-exclamation-triangle"></i> Google AI no configurado';
    }

    async function testGoogleAIConnection() {
        showInfo('Probando conexión con Google AI...');
        setTimeout(() => showSuccess('Conexión Google AI OK (simulado)'), 1000);
    }

    // Placeholder functions for other providers
    function saveBedrockConfig() { showSuccess('AWS Bedrock guardado (simulado)'); }
    function saveAnthropicConfig() { showSuccess('Anthropic guardado (simulado)'); }
    function saveAzureAIConfig() { showSuccess('Azure AI guardado (simulado)'); }
    function testBedrockConnection() { showSuccess('Conexión AWS Bedrock OK (simulado)'); }
    function testAnthropicConnection() { showSuccess('Conexión Anthropic OK (simulado)'); }
    function testAzureAIConnection() { showSuccess('Conexión Azure AI OK (simulado)'); }
    function updateBedrockStatus(configured) {}
    function updateAnthropicStatus(configured) {}
    function updateAzureAIStatus(configured) {}

    // ============================================================================
    // AUTHENTICATION MANAGEMENT
    // ============================================================================

    function loadAuthConfiguration() {
        const token = localStorage.getItem('authToken');
        const tokenExpiry = localStorage.getItem('tokenExpiry');
        const backendUrl = localStorage.getItem('backendUrl') || 'http://localhost:8846';
        
        document.getElementById('currentToken').value = token || 'No token disponible';
        document.getElementById('backendUrl').value = backendUrl;
        
        if (tokenExpiry) {
            const expiryDate = new Date(parseInt(tokenExpiry));
            document.getElementById('tokenExpiry').value = expiryDate.toLocaleString();
            updateCurrentTokenStatus(Date.now() < parseInt(tokenExpiry));
        } else {
            document.getElementById('tokenExpiry').value = 'No disponible';
            updateCurrentTokenStatus(false);
        }
    }

    function updateCurrentTokenStatus(isValid) {
        const statusDiv = document.getElementById('currentTokenStatus');
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${isValid ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'} me-2"></i>
                <span>${isValid ? 'Token válido' : 'Token inválido o expirado'}</span>
            </div>
        `;
    }

    function toggleTokenVisibility() {
        const tokenInput = document.getElementById('currentToken');
        const eyeIcon = document.getElementById('tokenEye');
        
        if (tokenInput.type === 'password') {
            tokenInput.type = 'text';
            eyeIcon.className = 'fas fa-eye-slash';
        } else {
            tokenInput.type = 'password';
            eyeIcon.className = 'fas fa-eye';
        }
    }

    async function refreshToken() {
        try {
            showInfo('Renovando token...');
            await authenticateWithBackend();
            loadAuthConfiguration();
            showSuccess('Token renovado exitosamente');
        } catch (error) {
            showError('Error renovando token');
        }
    }

    function revokeToken() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('tokenExpiry');
        loadAuthConfiguration();
        showSuccess('Token revocado');
    }

    async function manualAuthenticate() {
        const apiKey = document.getElementById('manualApiKey').value;
        const backendUrl = document.getElementById('backendUrl').value;
        
        if (!apiKey) {
            showError('API Key es requerida');
            return;
        }
        
        try {
            showInfo('Autenticando manualmente...');
            
            const response = await fetch(`${backendUrl}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            });
            
            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('authToken', data.access_token);
                localStorage.setItem('tokenExpiry', Date.now() + (data.expires_in * 1000));
                localStorage.setItem('backendUrl', backendUrl);
                loadAuthConfiguration();
                showSuccess('Autenticación manual exitosa');
            } else {
                showError('Error en autenticación manual');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function testAuthentication() {
        try {
            showInfo('Probando autenticación...');
            const data = await apiCall('/api/auth/verify');
            
            if (data.success) {
                showSuccess(`Autenticación válida (Usuario: ${data.user})`);
            } else {
                showError('Autenticación inválida');
            }
        } catch (error) {
            showError('Error probando autenticación');
        }
    }

    async function testAllConnections() {
        await checkSystemStatus();
        showSuccess('Pruebas de conexión completadas');
    }
</script>
{% endblock %}
