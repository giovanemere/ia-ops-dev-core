{% extends "base.html" %}

{% block title %}Dashboard - IA-Ops Portal{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1><i class="fas fa-rocket"></i> IA-Ops Portal</h1>
                <p class="lead">Portal de gestión unificada - Migrado a Dev-Core con arquitectura frontend/backend</p>
            </div>
            <div class="col-lg-4">
                <div class="d-grid gap-2">
                    <button class="btn btn-light btn-lg" onclick="refreshAll()">
                        <i class="fas fa-sync-alt"></i> Actualizar Todo
                    </button>
                    <button class="btn btn-outline-light" onclick="checkSystemHealth()">
                        <i class="fas fa-heartbeat"></i> Check Sistema
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3><i class="fas fa-bolt"></i> Acciones Rápidas</h3>
        <div class="actions-grid">
            <a href="#" class="action-btn" onclick="refreshRepositories()">
                <i class="fas fa-sync-alt"></i>
                Actualizar Repos
            </a>
            <a href="#" class="action-btn" onclick="buildAllRepositories()">
                <i class="fas fa-hammer"></i>
                Build All
            </a>
            <a href="#" class="action-btn" onclick="clearFailedTasks()">
                <i class="fas fa-trash-alt"></i>
                Limpiar Fallos
            </a>
            <a href="#" class="action-btn" onclick="testGitHubConnection()">
                <i class="fab fa-github"></i>
                Test GitHub
            </a>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="dashboard-grid">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-code-branch"></i> Repositorios</h5>
                <p class="card-text">Gestión de repositorios Git y sincronización automática</p>
                <div id="repoStats" class="loading">Cargando...</div>
                <a href="/repositories" class="btn btn-primary mt-3">Gestionar Repositorios</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-tasks"></i> Tareas</h5>
                <p class="card-text">Monitoreo de builds, deploys y procesos automáticos</p>
                <div id="taskStats" class="loading">Cargando...</div>
                <a href="/tasks" class="btn btn-secondary mt-3">Ver Tareas</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-book"></i> Documentación</h5>
                <p class="card-text">Portal TechDocs con búsqueda avanzada y builds automáticos</p>
                <div id="docsStats" class="loading">Cargando...</div>
                <a href="/techdocs" class="btn btn-success mt-3">Explorar Docs</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-chart-line"></i> Métricas</h5>
                <p class="card-text">Análisis de rendimiento y estadísticas del sistema</p>
                <div id="metricsStats" class="loading">Cargando...</div>
                <a href="/metrics" class="btn btn-warning mt-3">Ver Métricas</a>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="system-status">
        <h3><i class="fas fa-heartbeat"></i> Estado del Sistema</h3>
        <div class="status-grid" id="systemStatus">
            <div class="loading">Cargando estado del sistema...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadSystemStatus();
    });

    async function loadDashboardData() {
        try {
            const data = await apiCall('/api/v1/dashboard');
            
            if (data.success) {
                updateDashboardStats(data.data);
            } else {
                showError('Error cargando datos del dashboard');
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError('Error conectando con el backend');
        }
    }

    async function loadSystemStatus() {
        try {
            const data = await apiCall('/api/system/status');
            
            if (data.status === 'success') {
                updateSystemStatus(data.services);
            } else {
                showError('Error cargando estado del sistema');
            }
        } catch (error) {
            console.error('Error loading system status:', error);
            showError('Error conectando con el backend');
        }
    }

    function updateDashboardStats(data) {
        // Update repository stats
        document.getElementById('repoStats').innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <h4 class="text-primary">${formatNumber(data.repositories.total)}</h4>
                    <small>Total</small>
                </div>
                <div class="col-6">
                    <h4 class="text-success">${formatNumber(data.repositories.active)}</h4>
                    <small>Activos</small>
                </div>
            </div>
        `;

        // Update task stats
        document.getElementById('taskStats').innerHTML = `
            <div class="row text-center">
                <div class="col-4">
                    <h5 class="text-success">${formatNumber(data.tasks.completed)}</h5>
                    <small>Completadas</small>
                </div>
                <div class="col-4">
                    <h5 class="text-primary">${formatNumber(data.tasks.running)}</h5>
                    <small>Ejecutando</small>
                </div>
                <div class="col-4">
                    <h5 class="text-danger">${formatNumber(data.tasks.failed)}</h5>
                    <small>Fallidas</small>
                </div>
            </div>
        `;

        // Update docs stats
        document.getElementById('docsStats').innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <h4 class="text-info">${formatNumber(data.repositories.total)}</h4>
                    <small>Proyectos</small>
                </div>
                <div class="col-6">
                    <h4 class="text-warning">${formatNumber(data.repositories.total * 5)}</h4>
                    <small>Documentos</small>
                </div>
            </div>
        `;

        // Update metrics stats
        document.getElementById('metricsStats').innerHTML = `
            <div class="row text-center">
                <div class="col-4">
                    <h6 class="text-info">${data.system.cpu_usage}</h6>
                    <small>CPU</small>
                </div>
                <div class="col-4">
                    <h6 class="text-warning">${data.system.memory_usage}</h6>
                    <small>RAM</small>
                </div>
                <div class="col-4">
                    <h6 class="text-success">${data.system.uptime}</h6>
                    <small>Uptime</small>
                </div>
            </div>
        `;
    }

    function updateSystemStatus(services) {
        const statusContainer = document.getElementById('systemStatus');
        let html = '';

        // Dev-Core Services
        html += '<div class="status-item"><h4>Servicios Dev-Core</h4>';
        for (const [service, status] of Object.entries(services.dev_core_services)) {
            html += `<p>${service.replace('_', ' ')}: <span class="status ${status}">${status}</span></p>`;
        }
        html += '</div>';

        // External Services
        html += '<div class="status-item"><h4>Servicios Externos</h4>';
        for (const [service, status] of Object.entries(services.external_services)) {
            html += `<p>${service.toUpperCase()}: <span class="status ${status}">${status}</span></p>`;
        }
        html += '</div>';

        statusContainer.innerHTML = html;
    }

    // Quick Actions
    async function refreshRepositories() {
        try {
            showInfo('Actualizando repositorios...');
            const data = await apiCall('/api/repositories/refresh', 'POST');
            
            if (data.success) {
                showSuccess('Repositorios actualizados correctamente');
                loadDashboardData();
            } else {
                showError('Error actualizando repositorios');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function buildAllRepositories() {
        try {
            showInfo('Iniciando build de todos los repositorios...');
            const data = await apiCall('/api/build/all', 'POST');
            
            if (data.success) {
                showSuccess(`Build iniciado para ${data.tasks.length} repositorios`);
                loadDashboardData();
            } else {
                showError('Error iniciando builds');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function clearFailedTasks() {
        try {
            showInfo('Limpiando tareas fallidas...');
            const data = await apiCall('/api/tasks/failed/clear', 'POST');
            
            if (data.status === 'success') {
                showSuccess(`${data.cleared_count} tareas fallidas eliminadas`);
                loadDashboardData();
            } else {
                showError('Error limpiando tareas fallidas');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function testGitHubConnection() {
        try {
            showInfo('Probando conexión con GitHub...');
            const data = await apiCall('/api/github/test', 'POST');
            
            if (data.success) {
                showSuccess(`Conexión exitosa con GitHub (${data.user.login})`);
            } else {
                showError(`Error en conexión GitHub: ${data.error}`);
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function refreshAll() {
        await Promise.all([
            loadDashboardData(),
            loadSystemStatus()
        ]);
        showSuccess('Datos actualizados');
    }

    async function checkSystemHealth() {
        await loadSystemStatus();
        showInfo('Estado del sistema verificado');
    }
</script>
{% endblock %}
