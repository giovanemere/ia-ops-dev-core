{% extends "base.html" %}

{% block title %}Tareas - IA-Ops Portal{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1><i class="fas fa-tasks"></i> Gestión de Tareas</h1>
                <p class="lead">Monitoreo de builds, deploys y procesos automáticos del sistema</p>
            </div>
            <div class="col-lg-4">
                <div class="d-grid gap-2">
                    <button class="btn btn-light btn-lg" onclick="refreshTasks()">
                        <i class="fas fa-sync-alt"></i> Actualizar Tareas
                    </button>
                    <button class="btn btn-outline-light" onclick="clearFailedTasks()">
                        <i class="fas fa-trash-alt"></i> Limpiar Fallidas
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h3 id="completedTasks" class="text-success">-</h3>
                <p class="mb-0">Completadas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 id="runningTasks" class="text-primary">-</h3>
                <p class="mb-0">En Ejecución</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 id="failedTasks" class="text-danger">-</h3>
                <p class="mb-0">Fallidas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 id="queuedTasks" class="text-warning">-</h3>
                <p class="mb-0">En Cola</p>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <select class="form-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="running">En ejecución</option>
                        <option value="completed">Completadas</option>
                        <option value="failed">Fallidas</option>
                        <option value="queued">En cola</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="typeFilter">
                        <option value="">Todos los tipos</option>
                        <option value="build">Build</option>
                        <option value="sync">Sync</option>
                        <option value="deploy">Deploy</option>
                        <option value="techdocs">TechDocs</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary" onclick="refreshTasks()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearFailedTasks()">
                            <i class="fas fa-trash-alt"></i> Limpiar Fallidas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks List -->
    <div id="tasksList">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando tareas...</span>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- Task details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allTasks = [];
    let filteredTasks = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        
        // Filter functionality
        document.getElementById('statusFilter').addEventListener('change', filterTasks);
        document.getElementById('typeFilter').addEventListener('change', filterTasks);
        
        // Auto-refresh every 30 seconds
        setInterval(loadTasks, 30000);
    });

    async function loadTasks() {
        try {
            const data = await apiCall('/api/tasks');
            
            if (data.status === 'success') {
                allTasks = data.tasks || [];
                filteredTasks = [...allTasks];
                displayTasks(filteredTasks);
                updateStats(allTasks);
            } else {
                showMockTasks();
            }
        } catch (error) {
            console.error('Error loading tasks:', error);
            showMockTasks();
        }
    }

    function showMockTasks() {
        const mockTasks = [
            {
                id: 'build_001',
                name: 'Build ia-ops-dev-core',
                type: 'build',
                status: 'completed',
                created_at: new Date(Date.now() - 3600000).toISOString(),
                completed_at: new Date(Date.now() - 3000000).toISOString(),
                repository: 'ia-ops-dev-core'
            },
            {
                id: 'sync_002',
                name: 'Sync ia-ops-docs',
                type: 'sync',
                status: 'running',
                created_at: new Date(Date.now() - 1800000).toISOString(),
                repository: 'ia-ops-docs'
            },
            {
                id: 'build_003',
                name: 'Build ia-ops-veritas',
                type: 'build',
                status: 'failed',
                created_at: new Date(Date.now() - 7200000).toISOString(),
                completed_at: new Date(Date.now() - 6600000).toISOString(),
                error: 'Build failed: dependency not found',
                repository: 'ia-ops-veritas'
            }
        ];
        
        allTasks = mockTasks;
        filteredTasks = [...mockTasks];
        displayTasks(filteredTasks);
        updateStats(mockTasks);
    }

    function displayTasks(tasks) {
        const tasksList = document.getElementById('tasksList');
        
        if (tasks.length === 0) {
            tasksList.innerHTML = '<div class="text-center"><p class="text-muted">No hay tareas disponibles</p></div>';
            return;
        }

        let html = '';
        tasks.forEach(task => {
            const statusClass = getStatusClass(task.status);
            const typeIcon = getTypeIcon(task.type);
            const duration = task.completed_at ? 
                Math.round((new Date(task.completed_at) - new Date(task.created_at)) / 1000) : 
                Math.round((new Date() - new Date(task.created_at)) / 1000);
            
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${typeIcon} me-2"></i>
                                    <h6 class="mb-0 me-2">${task.name}</h6>
                                    <span class="badge ${statusClass}">${task.status}</span>
                                </div>
                                <div class="text-muted small">
                                    <span class="me-3">
                                        <i class="fas fa-clock"></i> ${formatDate(task.created_at)}
                                    </span>
                                    <span class="me-3">
                                        <i class="fas fa-stopwatch"></i> ${duration}s
                                    </span>
                                    ${task.repository ? `<span class="me-3"><i class="fas fa-code-branch"></i> ${task.repository}</span>` : ''}
                                </div>
                                ${task.error ? `<div class="text-danger small mt-1"><i class="fas fa-exclamation-triangle"></i> ${task.error}</div>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewTaskDetail('${task.id}')">
                                    <i class="fas fa-eye"></i> Ver Detalles
                                </button>
                                ${task.status === 'running' ? `
                                    <button class="btn btn-sm btn-outline-warning ms-1" onclick="cancelTask('${task.id}')">
                                        <i class="fas fa-stop"></i> Cancelar
                                    </button>
                                ` : ''}
                                ${task.status === 'failed' ? `
                                    <button class="btn btn-sm btn-outline-success ms-1" onclick="retryTask('${task.id}')">
                                        <i class="fas fa-redo"></i> Reintentar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        tasksList.innerHTML = html;
    }

    function updateStats(tasks) {
        const completed = tasks.filter(t => t.status === 'completed').length;
        const running = tasks.filter(t => t.status === 'running').length;
        const failed = tasks.filter(t => t.status === 'failed').length;
        const queued = tasks.filter(t => t.status === 'queued').length;
        
        document.getElementById('completedTasks').textContent = formatNumber(completed);
        document.getElementById('runningTasks').textContent = formatNumber(running);
        document.getElementById('failedTasks').textContent = formatNumber(failed);
        document.getElementById('queuedTasks').textContent = formatNumber(queued);
    }

    function filterTasks() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        
        filteredTasks = allTasks.filter(task => {
            const matchesStatus = !statusFilter || task.status === statusFilter;
            const matchesType = !typeFilter || task.type === typeFilter;
            
            return matchesStatus && matchesType;
        });
        
        displayTasks(filteredTasks);
    }

    function getStatusClass(status) {
        switch (status) {
            case 'completed': return 'bg-success';
            case 'running': return 'bg-primary';
            case 'failed': return 'bg-danger';
            case 'queued': return 'bg-warning';
            default: return 'bg-secondary';
        }
    }

    function getTypeIcon(type) {
        switch (type) {
            case 'build': return 'fas fa-hammer';
            case 'sync': return 'fas fa-sync-alt';
            case 'deploy': return 'fas fa-rocket';
            case 'techdocs': return 'fas fa-book';
            default: return 'fas fa-cog';
        }
    }

    async function viewTaskDetail(taskId) {
        try {
            const data = await apiCall(`/api/tasks/${taskId}`);
            
            if (data.status === 'success') {
                const task = data.task;
                const modalContent = document.getElementById('taskDetailContent');
                
                modalContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Información General</h6>
                            <p><strong>ID:</strong> ${task.id}</p>
                            <p><strong>Nombre:</strong> ${task.name}</p>
                            <p><strong>Tipo:</strong> ${task.type}</p>
                            <p><strong>Estado:</strong> <span class="badge ${getStatusClass(task.status)}">${task.status}</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Tiempos</h6>
                            <p><strong>Creado:</strong> ${formatDate(task.created_at)}</p>
                            ${task.started_at ? `<p><strong>Iniciado:</strong> ${formatDate(task.started_at)}</p>` : ''}
                            ${task.completed_at ? `<p><strong>Completado:</strong> ${formatDate(task.completed_at)}</p>` : ''}
                        </div>
                    </div>
                    ${task.result ? `
                        <div class="mt-3">
                            <h6>Resultado</h6>
                            <pre class="bg-light p-2 rounded">${task.result}</pre>
                        </div>
                    ` : ''}
                    ${task.error ? `
                        <div class="mt-3">
                            <h6>Error</h6>
                            <div class="alert alert-danger">${task.error}</div>
                        </div>
                    ` : ''}
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
                modal.show();
            } else {
                showError('Error cargando detalles de la tarea');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    async function refreshTasks() {
        try {
            await loadTasks();
            showSuccess('Tareas actualizadas');
        } catch (error) {
            showError('Error actualizando tareas');
        }
    }

    async function clearFailedTasks() {
        try {
            const data = await apiCall('/api/tasks/failed/clear', 'POST');
            
            if (data.status === 'success') {
                showSuccess(`${data.cleared_count} tareas fallidas eliminadas`);
                await loadTasks();
            } else {
                showError('Error limpiando tareas fallidas');
            }
        } catch (error) {
            showError('Error conectando con el backend');
        }
    }

    function cancelTask(taskId) {
        showInfo(`Cancelando tarea ${taskId}...`);
        // Implementar cancelación de tarea
    }

    function retryTask(taskId) {
        showInfo(`Reintentando tarea ${taskId}...`);
        // Implementar reintento de tarea
    }
</script>
{% endblock %}
